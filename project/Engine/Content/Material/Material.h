#pragma once

//-----------------------------------------------------------------------------------------
// include
//-----------------------------------------------------------------------------------------
//* engine
#include <Engine/System/DirectX/DxObject/DxDimensionBuffer.h>
#include <Engine/System/DirectX/DirectXAlignment.h>

//* lib
#include <Lib/Traits.h>
#include <Lib/Geometry/Color.h>
#include <Lib/Geometry/Matrix4x4.h>
#include <Lib/Transform/Transform.h>

////////////////////////////////////////////////////////////////////////////////////////////
// Material class
////////////////////////////////////////////////////////////////////////////////////////////
class Material
	: public IJsonSerializer {
public:

	////////////////////////////////////////////////////////////////////////////////////////////
	// State enum class 
	////////////////////////////////////////////////////////////////////////////////////////////
	enum class BlendMode : uint8_t {
		Opaque,      //!< 不透明
		Translucent, //!< 半透明
	};

	////////////////////////////////////////////////////////////////////////////////////////////
	// Channel enum class
	////////////////////////////////////////////////////////////////////////////////////////////
	enum class Channel : uint32_t { //!< Textureのchannel指定用
		r = 0,
		g = 1,
		b = 2,
		a = 3,
	};

	////////////////////////////////////////////////////////////////////////////////////////////
	// Albedo structure
	////////////////////////////////////////////////////////////////////////////////////////////
	struct Albedo {
	public:

		////////////////////////////////////////////////////////////////////////////////////////////
		// Type enum class
		////////////////////////////////////////////////////////////////////////////////////////////
		enum class Type : uint32_t {
			Value,
			Texture,
			Multiply,
		};

	public:

		//=========================================================================================
		// public methods
		//=========================================================================================

		void Init();

		//* option *//

		void SetValue(const Color3f& _color);

		void SetTexture(uint32_t _index);

		void SetMultiply(const Color3f& _color, const std::optional<uint32_t>& _index = std::nullopt);

		//* debug *//

		void SetImGuiCommand();

		//=========================================================================================
		// public variables
		//=========================================================================================

		Type type = Type::Value;

		Color3f color = kWhite3;
		uint32_t index = NULL;

	};

	////////////////////////////////////////////////////////////////////////////////////////////
	// Transparency structure
	////////////////////////////////////////////////////////////////////////////////////////////
	struct Transparency {
	public:

		////////////////////////////////////////////////////////////////////////////////////////////
		// Type enum class
		////////////////////////////////////////////////////////////////////////////////////////////
		enum class Type : uint32_t {
			Value,
			Texture,
		};

	public:

		//=========================================================================================
		// public methods
		//=========================================================================================

		void Init();

		//* option *//

		void SetValue(float _alpha);

		void SetTexture(uint32_t _index);

		//* debug *//

		void SetImGuiCommand();

		//=========================================================================================
		// public variables
		//=========================================================================================

		Type type = Type::Value;

		float alpha = 1.0f;
		uint32_t index = NULL;

	};

	////////////////////////////////////////////////////////////////////////////////////////////
	// Normal structure
	////////////////////////////////////////////////////////////////////////////////////////////
	struct Normal {
	public:

		////////////////////////////////////////////////////////////////////////////////////////////
		// Type enum class
		////////////////////////////////////////////////////////////////////////////////////////////
		enum class Type : uint32_t {
			None,
			Texture,
		};

	public:

		//=========================================================================================
		// public methods
		//=========================================================================================

		void Init();

		//* option *//

		void SetNone();

		void SetTexture(uint32_t _index);

		//* debug *//

		void SetImGuiCommand();

		//=========================================================================================
		// public variables
		//=========================================================================================

		Type type = Type::None;

		uint32_t index = NULL;

	};

	////////////////////////////////////////////////////////////////////////////////////////////
	// Property structure
	////////////////////////////////////////////////////////////////////////////////////////////
	struct Property { //!< helper struct
	public:

		////////////////////////////////////////////////////////////////////////////////////////////
		// Type enum class
		////////////////////////////////////////////////////////////////////////////////////////////
		enum class Type : uint32_t {
			Value,
			Texture,
		};

	public:

		//=========================================================================================
		// public methods
		//=========================================================================================

		void Init();

		//* option *//

		void SetValue(float _value);

		void SetTexture(uint32_t _index);

		//* debug *//

		void SetImGuiCommand();

		//=========================================================================================
		// public methods
		//=========================================================================================

		Type type = Type::Value;

		float value = 0.0f;
		uint32_t index = NULL;

	};

	////////////////////////////////////////////////////////////////////////////////////////////
	// SurfaceProperties structure
	////////////////////////////////////////////////////////////////////////////////////////////
	struct SurfaceProperties {
	public:

		//=========================================================================================
		// public methods
		//=========================================================================================

		void Init();

		//* debug *//

		void SetImGuiCommand();

		//=========================================================================================
		// public variables
		//=========================================================================================

		Property metallic;
		Property specular;
		Property roughness;

	};

	////////////////////////////////////////////////////////////////////////////////////////////
	// Transform structure
	////////////////////////////////////////////////////////////////////////////////////////////
	struct Transform {
	public:

		//=========================================================================================
		// public methods
		//=========================================================================================

		void Init();

		void Transfer(const Matrix4x4& _mat);

		//=========================================================================================
		// public variables
		//=========================================================================================

		Matrix4x4 mat;

	};

	////////////////////////////////////////////////////////////////////////////////////////////
	// MaterialBuffer structure
	////////////////////////////////////////////////////////////////////////////////////////////
	struct MaterialBuffer {
	public:

		//=========================================================================================
		// public methods
		//=========================================================================================

		void Init();

		//=========================================================================================
		// public variables
		//=========================================================================================

		Transform         transform;
		Albedo            albedo;
		Transparency      transparency;
		Normal            normal;
		SurfaceProperties properties;

	};
	// todo: 各parameterをprivateにする

public:

	//=========================================================================================
	// public methods
	//=========================================================================================

	Material()  = default;
	~Material() = default;

	void CreateBuffer();

	//* material option *//

	const MaterialBuffer& GetMaterial() const;
	MaterialBuffer& GetMaterial();

	//* transform option *//

	void TransferUVMatrix();

	const Transform2d& GetTransform() const { return transform_; }
	Transform2d& GetTransform() { return transform_; }

	//* blend mode *//

	void SetBlendMode(BlendMode mode) { mode_ = mode; }

	const BlendMode GetBlendMode() const { return mode_; }

	//* getter *//

	const D3D12_GPU_VIRTUAL_ADDRESS& GetGPUVirtualAddress() const;

	_DEFAULT_MOVE(Material)

	//* imgui *//

	void SetImGuiCommand();

	//* json *//

	json OutputJson() const override;

	void InputJson(const json& data) override;

private:

	//=========================================================================================
	// private variables
	//=========================================================================================

	BlendMode mode_ = BlendMode::Opaque;

	Transform2d transform_ = {};
	std::unique_ptr<DxObject::DimensionBuffer<MaterialBuffer>> buffer_ = nullptr;

};
